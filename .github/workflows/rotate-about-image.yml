name: rotate-about-image

on:
  schedule:
    # Run every hour; the job computes the Paris date and only commits when the
    # chosen image changes. This avoids DST headaches and ensures midnight Paris.
    - cron: "7 * * * *"
  workflow_dispatch:

# Prevent race conditions between scheduled and manual runs
concurrency:
  group: rotate-about-image
  cancel-in-progress: false  # Queue runs instead of canceling

permissions:
  contents: write

jobs:
  rotate:
    runs-on: ubuntu-latest

    steps:
      # 1) Check out gh-pages (published site)
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with:
          ref: gh-pages

      # 2) Also fetch source branch to read source images and Python script
      - name: Fetch source branch
        run: |
          git fetch origin main:main
          git worktree add ../src main

      # 3) Setup Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      # 4) Install system dependencies
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libavif-dev

      # 5) Install dependencies
      - name: Install dependencies
        run: |
          pip install pillow pillow-avif-plugin

      # 6) Run rotation script
      - name: Rotate image
        id: rotate
        run: |
          # Copy script from source branch
          cp ../src/rotate-image.py .

          # Create output directory
          mkdir -p img/about

          # Run rotation (reads from ../src/img/about-src/, writes to img/about/)
          # Exit explicitly on failure to ensure workflow fails visibly
          python rotate-image.py \
            --repository "$GITHUB_REPOSITORY" \
            --src-dir ../src/img/about-src \
            --output img/about/image.avif || { echo "Image rotation failed"; exit 1; }

          # Capture Paris date for commit message
          PARIS_DATE=$(python -c "from datetime import datetime; from zoneinfo import ZoneInfo; print(datetime.now(ZoneInfo('Europe/Paris')).strftime('%Y-%m-%d'))")
          echo "date=$PARIS_DATE" >> "$GITHUB_OUTPUT"

      # 7) Commit only if the file actually changed
      - name: Commit to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add img/about/image.avif
          git diff --staged --quiet && echo "No changes today." && exit 0
          git commit -m "Rotate about image for ${{ steps.rotate.outputs.date }} [skip ci]"
          git push origin gh-pages
